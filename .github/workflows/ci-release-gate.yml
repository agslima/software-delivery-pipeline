name: "Release"

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Existing tag (e.g., v1.2.3)'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  TRIVY_VERSION: "0.58.1"
  ZAP_TARGET_FRONTEND: "http://127.0.0.1:4173"
  ZAP_TARGET_BACKEND: "http://127.0.0.1:8080"
  # Canonical predicateTypes (Aligned with Kyverno policies)
  TRIVY_PREDICATE_TYPE: "https://security.sigstore.dev/attestations/vuln/trivy/v1"
  ZAP_PREDICATE_TYPE: "https://security.sigstore.dev/attestations/dast/zap/v1"
  SBOM_PREDICATE_TYPE: "https://spdx.dev/Document"

jobs:

  # ==================================================================
  # JOB 0: Resolve Tag + Checkout Deterministically
  # ==================================================================
  resolve:
    name: Resolve Release Tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      release_tag: ${{ steps.tag.outputs.release_tag }}
    steps:

      - name: Set Release Tag
        id: tag
        env:
          # 1. Map contexts to Environment Variables
          EVENT_NAME: ${{ github.event_name }}
          TAG_INPUT: ${{ inputs.tag }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          # 2. Reference the Environment Variables using shell syntax ($VAR)
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "release_tag=$TAG_INPUT" >> "$GITHUB_OUTPUT"
          else
            echo "release_tag=$REF_NAME" >> "$GITHUB_OUTPUT"
          fi

  # ==================================================================
  # JOB 1: Build + Push (Digest is the artifact identity)
  # ==================================================================
  build-push:
    name: Build & Push (Digest)
    runs-on: ubuntu-latest
    needs: [resolve]
    environment: production
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: true
      matrix:
        include:
          - name: backend
            context: app
            file: app/docker/Dockerfile.server
            image_repo: app-stayheathy-backend
          - name: frontend
            context: app
            file: app/docker/Dockerfile.client
            image_repo: app-stayheathy-frontend
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.release_tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f #v3.12.0

      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build & Push
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}:${{ needs.resolve.outputs.release_tag }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}:${{ github.sha }}

      - name: Export Digest Artifact
        run: |
          set -euo pipefail
          mkdir -p digests
          DIGEST="${{ steps.build.outputs.digest }}"
          test -n "$DIGEST" || (echo "::error::Digest empty"; exit 1)
          echo "$DIGEST" > "digests/digest-${{ matrix.name }}"
          echo "IMAGE=${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}@$DIGEST" >> "$GITHUB_ENV"

      - name: Upload Digest Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: digest-${{ matrix.name }}
          path: digests/digest-${{ matrix.name }}
          retention-days: 30

  # ==================================================================
  # JOB 2: Trivy Scan (1 run per image digest) + gate
  # ==================================================================
  trivy-scan:
    name: Trivy Scan (Digest Gate)
    runs-on: ubuntu-latest
    needs: [build-push, resolve]
    permissions:
      contents: read
    strategy:
      fail-fast: true
      matrix:
        include:
          - name: backend
            image_repo: app-stayheathy-backend
          - name: frontend
            image_repo: app-stayheathy-frontend
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.release_tag }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4.1.7
        with:
          name: digest-${{ matrix.name }}
          path: digests

      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Install Trivy
        run: |
          set -euo pipefail
          curl -sfL "https://raw.githubusercontent.com/aquasecurity/trivy/v${{ env.TRIVY_VERSION }}/contrib/install.sh" | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Scan Image (JSON)
        run: |
          set -euo pipefail
          DIGEST="$(cat digests/digest-${{ matrix.name }})"
          IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}@$DIGEST"
          echo "Scanning $IMAGE"

          trivy image \
            --format json \
            --output "trivy-${{ matrix.name }}.json" \
            "$IMAGE"

          # Explicit output checks (fail closed)
          test -s "trivy-${{ matrix.name }}.json" || (echo "::error::Trivy JSON missing/empty"; exit 1)
          jq -e '.Results? | type=="array"' "trivy-${{ matrix.name }}.json" >/dev/null

      - name: Gate (CRITICAL>0 or HIGH>5)
        run: |
          set -euo pipefail
          FILE="trivy-${{ matrix.name }}.json"
          CRIT=$(jq '[.Results[]? | (.Vulnerabilities // [])[] | select(.Severity=="CRITICAL")] | length' "$FILE")
          HIGH=$(jq '[.Results[]? | (.Vulnerabilities // [])[] | select(.Severity=="HIGH")] | length' "$FILE")
          echo "CRITICAL=$CRIT HIGH=$HIGH"

          if [ "$CRIT" -gt 0 ] || [ "$HIGH" -gt 5 ]; then
            echo "::error::‚õî Trivy Gate Failed for ${{ matrix.name }} (CRIT=$CRIT HIGH=$HIGH)"
            exit 1
          fi
          echo "‚úÖ Trivy Gate Passed"

      - name: Upload Trivy Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: trivy-results-${{ matrix.name }}
          path: trivy-${{ matrix.name }}.json
          retention-days: 30

  # ==================================================================
  # JOB 3: DAST (compose uses the exact digests) + gate
  # ==================================================================
  dast-analysis:
    name: DAST (Digest-based)
    runs-on: ubuntu-latest
    needs: [trivy-scan, build-push, resolve]
    permissions:
      contents: read
    env:
      ZAP_IMG: ghcr.io/zaproxy/zaproxy@sha256:8e79e827afb9e8bdba390c829eb3062062cdb407570559e2ddebd49130c00a59
      HEALTH_TIMEOUT: "120" # seconds
      COMPOSE_PROJECT_NAME: dast-${{ github.run_id }}-${{ github.run_attempt }} 

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.release_tag }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4.1.7
        with:
          name: digest-backend
          path: digests
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4.1.7
        with:
          name: digest-frontend
          path: digests

      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set Variables + Compose Secrets (file-based)
        working-directory: app
        run: |
          set -euo pipefail

          # Keep secrets OUT of workspace: use RUNNER_TEMP
          SECRETS_DIR="${RUNNER_TEMP}/compose-secrets"
          ENV_FILE=".env"

          rm -f "$ENV_FILE"
          rm -rf "$SECRETS_DIR"
          mkdir -p "$SECRETS_DIR"

          # Non-secret env vars
          {
            echo "ADMIN_USER=${{ vars.ADMIN_USER }}"
            echo "DB_USER=${{ vars.DB_USER }}"
            echo "DB_NAME=${{ vars.DB_NAME }}"
            echo "COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}"
            echo "SECRETS_PATH=${SECRETS_DIR}"
          } >> "$ENV_FILE"
          chmod 600 "$ENV_FILE"

          # Compose secrets files
          printf "%s" "${{ secrets.JWT_SECRET }}" > "${SECRETS_DIR}/jwt_secret.txt"
          printf "%s" "${{ secrets.ADMIN_PASS }}" > "${SECRETS_DIR}/admin_pass.txt"
          printf "%s" "${{ secrets.DB_PASS }}" > "${SECRETS_DIR}/db_pass.txt"
          chmod 600 "${SECRETS_DIR}"/*.txt

          echo "Secrets dir: ${SECRETS_DIR}"

      - name: Start Ephemeral Environment (Pinned Digests)
        working-directory: app
        run: |
          set -euo pipefail

          BACKEND_DIGEST="$(cat ../digests/digest-backend)"
          FRONTEND_DIGEST="$(cat ../digests/digest-frontend)"

          export BACKEND_IMAGE="docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/app-stayheathy-backend@$BACKEND_DIGEST"
          export FRONTEND_IMAGE="docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/app-stayheathy-frontend@$FRONTEND_DIGEST"

          echo "BACKEND_IMAGE=$BACKEND_IMAGE"
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE"

          # Compose should reference BACKEND_IMAGE / FRONTEND_IMAGE
          docker compose -f docker-compose.yml -f docker-compose.release.yml up -d

          echo "‚è≥ Waiting for Backend..."
          timeout 90s bash -c 'until curl -s http://127.0.0.1:8080/health > /dev/null; do sleep 5; done'
          echo "‚è≥ Waiting for Frontend..."
          timeout 90s bash -c 'until curl -s http://127.0.0.1:4173 > /dev/null; do sleep 5; done'
          docker compose ps
          echo "‚úÖ Application is live!"

      - name: OWASP ZAP Baseline (Frontend)
        working-directory: app
        run: |
          set -euo pipefail
          mkdir -p zap-out
          chmod 777 zap-out

          VOL_PATH="$(pwd)/zap-out"
          echo "ZAP volume: $VOL_PATH"
          echo "ZAP image: ${{ env.ZAP_IMG }}"

          docker run --rm \
            --network host \
            -v "$VOL_PATH:/zap/wrk/:rw" \
            "${{ env.ZAP_IMG }}" zap-baseline.py \
            -t "${{ env.ZAP_TARGET_FRONTEND }}" \
            -r zap-frontend.html \
            -J zap-frontend.json \
            -I || true

          test -s "zap-out/zap-frontend.json" || (echo "::error::ZAP frontend JSON missing/empty (scanner crash?)"; exit 1)
          jq -e 'type=="object"' "zap-out/zap-frontend.json" >/dev/null

      - name: OWASP ZAP Baseline (Backend)
        working-directory: app
        run: |
          set -euo pipefail

          VOL_PATH="$(pwd)/zap-out"

          docker run --rm \
            --network host \
            -v "$VOL_PATH:/zap/wrk/:rw" \
            "${{ env.ZAP_IMG }}" zap-baseline.py \
            -t "${{ env.ZAP_TARGET_BACKEND }}" \
            -r zap-backend.html \
            -J zap-backend.json \
            -I || true

          test -s "zap-out/zap-backend.json" || (echo "::error::ZAP backend JSON missing/empty (scanner crash?)"; exit 1)
          jq -e 'type=="object"' "zap-out/zap-backend.json" >/dev/null


      - name: Gate ZAP (High > 0)
        working-directory: app
        run: |
          set -euo pipefail

          for FILE in zap-out/zap-frontend.json zap-out/zap-backend.json; do
            test -s "$FILE" || (echo "::error::ZAP report missing/empty: $FILE"; exit 1)
            jq -e 'type=="object"' "$FILE" >/dev/null

            HIGHS=$(jq '[.site[]? | .alerts[]? | select(.riskcode=="3")] | length' "$FILE")
            echo "$FILE => High=$HIGHS"
            if [ "$HIGHS" -gt 0 ]; then
              echo "::error::‚õî DAST Gate Failed ($FILE High=$HIGHS)"
              exit 1
            fi
          done

          echo "‚úÖ DAST Gate Passed"

      - name: Upload ZAP Artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: zap-results
          path: app/zap-out/
          retention-days: 30

      - name: Cleanup Secrets + Env
        if: always()
        working-directory: app
        run: |
          set -euo pipefail
          rm -f .env
          if [ -n "${COMPOSE_SECRETS_DIR:-}" ] && [ -d "${COMPOSE_SECRETS_DIR:-}" ]; then
            rm -rf "${COMPOSE_SECRETS_DIR}"
          fi

      - name: Teardown
        if: always()
        working-directory: app
        run: docker compose down -v --remove-orphans

  # ==================================================================
  # JOB 4: Sign + Attest + SBOM + Provenance (only after gates)
  # ==================================================================
  sign-and-attest:
    name: Sign & Attest (Governed)
    runs-on: ubuntu-latest
    needs: [dast-analysis, build-push, trivy-scan, resolve]
    environment: production
    permissions:
      contents: write
      id-token: write
      attestations: write
    strategy:
      fail-fast: true
      matrix:
        include:
          - name: backend
            image_repo: app-stayheathy-backend
          - name: frontend
            image_repo: app-stayheathy-frontend
    #env:
      # COSIGN_LOG_LEVEL: debug
      # COSIGN_DOCKER_MEDIA_TYPES: "1"
      # COSIGN_REGISTRY_REFERRERS_MODE: legacy
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ needs.resolve.outputs.release_tag }}

      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad #v4.0.0

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4.1.7
        with:
          name: digest-${{ matrix.name }}
          path: digests

      - name: Read Digest
        run: |
          set -euo pipefail
          DIGEST="$(cat digests/digest-${{ matrix.name }})"
          echo "DIGEST=$DIGEST" >> "$GITHUB_ENV"
          echo "IMAGE=docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}@$DIGEST" >> "$GITHUB_ENV"

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4.1.7
        with:
          name: trivy-results-${{ matrix.name }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4.1.7
        with:
          name: zap-results
          path: zap-downloads

      - name: Create & Push Trivy Attestation (from scan artifact)
        run: |
          set -euo pipefail
          FILE="trivy-${{ matrix.name }}.json"
          test -s "$FILE" || (echo "::error::Missing trivy JSON"; exit 1)

          jq '
            ([.Results[]? | (.Vulnerabilities // [])[] | select(.Severity=="CRITICAL")] | length) as $crit |
            ([.Results[]? | (.Vulnerabilities // [])[] | select(.Severity=="HIGH")] | length) as $high |
            {
              scanner: { name: "trivy", version: env.TRIVY_VERSION, uri: "https://github.com/aquasecurity/trivy" },
              summary: { critical: $crit, high: $high },
              result: (if ($crit > 0 or $high > 5) then "FAIL" else "PASS" end),
              timestamp: (now | todate)
            }
          ' "$FILE" > trivy-attestation.json

          cosign attest --yes \
            --predicate trivy-attestation.json \
            --type "${{ env.TRIVY_PREDICATE_TYPE }}" \
            "$IMAGE"

      - name: Create & Push ZAP Attestation (from DAST artifacts)
        run: |
          set -euo pipefail
          FE="zap-downloads/zap-frontend.json"
          BE="zap-downloads/zap-backend.json"
          test -s "$FE" || (echo "::error::Missing ZAP FE json"; exit 1)
          test -s "$BE" || (echo "::error::Missing ZAP BE json"; exit 1)

          HIGH_FE=$(jq '[.site[]? | .alerts[]? | select(.riskcode=="3")] | length' "$FE")
          HIGH_BE=$(jq '[.site[]? | .alerts[]? | select(.riskcode=="3")] | length' "$BE")
          HIGH=$((HIGH_FE + HIGH_BE))

          jq -n --argjson high "$HIGH" '
            {
              scanner: { name: "owasp-zap", uri: "https://www.zaproxy.org/" },
              summary: { high: $high },
              result: (if ($high > 0) then "FAIL" else "PASS" end),
              timestamp: (now | todate)
            }
          ' > zap-attestation.json

          cosign attest --yes \
            --predicate zap-attestation.json \
            --type "${{ env.ZAP_PREDICATE_TYPE }}" \
            "$IMAGE"

      - name: Sign Image
        run: |
          set -euo pipefail
          cosign version
          echo "IMAGE=$IMAGE"
          cosign sign --yes "$IMAGE"

      - name: Verify Signature (OIDC identity)
        run: |
          set -euo pipefail

          # üü¢ Retry up to 5 times with increasing backoff
          for i in 1 2 3 4 5; do
            echo "üîç Verify attempt $i/5..."
            if cosign verify \
              "$IMAGE" \
              --certificate-oidc-issuer https://token.actions.githubusercontent.com \
              --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/ci-release-gate\.yml@refs/tags/v.*"; then
              echo "‚úÖ Signature Verified!"
              exit 0
            fi

            echo "‚ö†Ô∏è Verification failed. Retrying in $((i*5)) seconds..."
            sleep $((i*5))
          done

          echo "::error::‚ùå Verify failed after 5 attempts. Check Registry consistency or Auth."
          exit 1

      - name: Generate SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad #v0.22.2
        with:
          image: ${{ env.IMAGE }}
          format: spdx-json
          output-file: sbom-${{ matrix.name }}.spdx.json
          artifact-name: sbom-${{ matrix.name }}.spdx.json

      - name: Attest SBOM
        run: |
          cosign attest --yes \
            --predicate "sbom-${{ matrix.name }}.spdx.json" \
            --type "${{ env.SBOM_PREDICATE_TYPE }}" \
            "$IMAGE"

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f #v3.2.0
        with:
          subject-name: docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}
          subject-digest: ${{ env.DIGEST }}
          push-to-registry: true
